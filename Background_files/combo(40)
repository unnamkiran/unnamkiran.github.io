YUI.add("albums-list-route",function(e){function s(e){s.superclass.constructor.call(this,e)}var t=require("lib/helpers/type-validator"),n=25,r=50,i=100;e.Routes[this.name]=s,e.extend(s,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(s){var o=this,u={},a,f,l=s.params.nsid_or_path_alias,c=s.params&&s.params.set_id,h=c?i:n,p=this.getPageNumber(s),d;return t.nsid(l)?u.id=l:u.pathAlias=l,f="/photos/"+l+"/albums/",a={page:i/h*(p-1)+1,perPage:h,withSetId:c},e.Promise.all([this.appContext.getModel("sets-models",u,a),this.appContext.getModel("person-models",u),this.appContext.getModel("person-contacts-count-models",u)]).then(function(n){var u=n[0],h=n[1],v=0;if(YUI.Env.isServer){v=Math.ceil(u.getValue("totalItems")/i);if(p>v&&a.page>1&&!isNaN(parseInt(s.params.page_number,10)))return e.Promise.resolve({redirect:f.replace(/page[0-9]+/,"")})}if(c){var m=u.getValue("albumsList");d=m.getPageOf({id:c},r);if(d===-1||m.getNextIncompletePage(a)===d)return a.forceAPICall=!0,t.nsid(l)?a.id=l:a.pathAlias=l,m.getPage(a).then(function(e){return p=Math.ceil(m.getPageOf({id:c},r)*r/i),d=p,o.onRouteResolved(u,h,p,d,f,c)},function(t){return e.Promise.resolve({redirect:f})});p=Math.ceil(d*r/i),d=p}else d=i/r*(p-1)+1;return o.onRouteResolved(u,h,p,d,f,c)},function(t){return t&&c?e.Promise.resolve({redirect:f}):t.timeout?o.appContext.getModel("person-models",u).then(function(t){var n=t.getValue("displayname"),r={view:"empty-page-view",layout:"scrolling",title:o.intlMessage({intlName:"common.USERS_ALBUMS",who:n}),params:{isSlow:!0,page:"albums",displayName:n,nsid:t.getValue("nsid")}};return e.Promise.resolve(r)},function(){return o.onRouteRejected(t,s)}):o.onRouteRejected(t,s)})},onRouteResolved:function(t,n,s,o,u,a){var f,l=t.getValue("totalItems"),c=n.getValue("displayname");return parseInt(l,10)===0&&this.appContext.flipper.isFlipped("enable-new-empty-state-pages")?f={view:"empty-page-view",layout:"scrolling",title:this.intlMessage({intlName:"common.USERS_ALBUMS",who:c}),params:{displayName:c,nsid:n.getValue("nsid"),page:"albums"}}:f={view:"albums-list-page-view",layout:"scrolling",title:this.intlMessage({intlName:"common.USERS_ALBUMS",who:c}),params:{nsid:t.id,withSetId:a,pageParams:{page:o,perPage:a?i:r,viewPageSize:i,nominalPage:s},baseURL:u}},e.Promise.resolve(f)},onRouteRejected:function(t,n){var r=n.params.nsid_or_path_alias,i="Couldn't load albums list page",s=this.appContext.getViewer().nsid;if(r==="me"&&s)return e.Promise.resolve({redirect:"/photos/"+s+"/albums/"});t.message&&(i+=": "+t.message);if(t.fatal)throw t;return this.displayRouteErrors(n,new e.RouteError(404,i))}}),e.mix(s.prototype,e.Localizable)},"@VERSION@",{requires:["flickr-route","flickr-promise","sets-models","person-models"],langBundles:["common"]});
