YUI.add("photostream-route",function(e){function o(e){o.superclass.constructor.call(this,e)}var t=require("lib/helpers/type-validator"),n=25,r=50,i=100,s="pu";e.Routes[this.name]=o,e.extend(o,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(o){var u=this,a,f,l=o.params.nsid_or_path_alias,c=o.headers?o.headers["user-agent"]:!1,h=o.params&&o.params.photo_id,p=h?i:n,d=this.getPageNumber(o),v,m={},g=[];c&&c.match(/^Twitterbot/i)!==null?this.isTwitterbot=!0:this.isTwitterbot=!1,f="/photos/"+l+"/",a={page:i/p*(d-1)+1,perPage:p,withPhotoId:h},a.orderBy="use_pref",a.viewAs="use_pref",a.createCompoundID=!0,t.nsid(l)?m.id=l:m.pathAlias=l;if(this.appContext.getViewer().signedIn||o.probableUser)g.push(this.appContext.getModel("person-preferences-models",this.appContext.getViewer().signedIn?this.appContext.getViewer().nsid:o.probableUser)),g.push(this.appContext.getModel("person-contacts-count-models",m));return e.Promise.all(g).then(null,function(e){if(e.getModelFailure&&o.probableUser)return o.probableUser=null,[];throw e}).then(function(n){var c,p=n[0]?n[0]:!1,g,y,b=0,w={};return t.nsid(l)&&p&&(s=p.getValue("photostreamViewAsPref"),g=u.buildContextSuffix(p,l),m.id=l+"-"+g),u.appContext.getModel("photostream-models",m,a).then(function(n){y=n.getValue("owner").getValue("nsid");if(YUI.Env.isServer){b=Math.ceil(n.getValue("totalItems")/i);if(d>b&&a.page>1&&!isNaN(parseInt(o.params.page_number,10)))return e.Promise.resolve({redirect:f.replace(/page[0-9]+/,"")})}t.nsid(l)||(p?(s=p.getValue("photostreamViewAsPref"),g=u.buildContextSuffix(p,y),m.id=y+"-"+g):m.id=y),w.withPhotoId=h,w.contextSuffix=g,w.baseURL=f;if(h){c=n.getValue("photoPageList"),v=c.getPageOf({id:h},r);if(v===-1||c.getNextIncompletePage(a)===v)return a.forceAPICall=!0,t.nsid(l)?a.id=l:a.pathAlias=l,c.getPage(a).then(function(e){return d=Math.ceil(c.getPageOf({id:h},r)*r/i),v=d,u.onRouteResolved(n,d,v,w)},function(t){return e.Promise.resolve({redirect:f})});d=Math.ceil(c.getPageOf({id:h},r)*r/i),v=d}else v=i/r*(d-1)+1;return u.onRouteResolved(n,d,v,w)},function(t){return t&&h?e.Promise.resolve({redirect:f}):t.timeout?u.appContext.getModel("person-models",m).then(function(t){var n=t.getValue("displayname"),r={view:"empty-page-view",layout:"scrolling",title:n,params:{isSlow:!0,viewAs:s,page:"photostream",displayName:n,nsid:t.getValue("nsid")}};return e.Promise.resolve(r)},function(){return u.onRouteRejected(t,o)}):u.onRouteRejected(t,o,f)})}).catch(function(e){return u.onRouteRejected(e,o,f)})},buildContextSuffix:function(t,n){return e.Models["person-preferences-models"].buildContextSuffix(t,n)},onRouteResolved:function(t,n,o,u){var a,f=t.getValue("totalItems"),l=t.getValue("owner").getValue("displayname"),c=t.getValue("owner").getValue("nsid");return parseInt(f,10)===0&&this.appContext.flipper.isFlipped("enable-new-empty-state-pages")?a={view:"empty-page-view",layout:"scrolling",title:l,params:{displayName:l,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,viewAs:s,page:"photostream"}}:a={view:"photostream-page-view",layout:"scrolling",title:l,params:{nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,withPhotoId:u.withPhotoId,isTwitterbot:this.isTwitterbot,contextId:c+"-"+u.contextSuffix,pageParams:{page:o,perPage:u.withPhotoId?i:r,viewPageSize:i,nominalPage:n,idAttribute:"contextId",createCompoundID:!0},baseURL:u.baseURL,contextSuffix:u.contextSuffix}},e.Promise.resolve(a)},onRouteRejected:function(t,n,r){var i="Couldn't load photostream page";if(t.code===15)return e.Promise.resolve({redirect:r});t.message&&(i+=": "+t.message);if(t.fatal)throw t;return this.displayRouteErrors(n,new e.RouteError(404,i))}})},"@VERSION@",{requires:["flickr-route","flickr-promise","photostream-models","person-preferences-models"]});
